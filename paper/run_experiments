#!/bin/bash

jobs=$1
[[ "$jobs" = "" ]] && jobs=1

echo "Starting $1 parallel jobs"

source ./generate_tests.conf
for dir in "$inputdir" "$outputdir" "$okdir"
do
    test -d "$dir" || mkdir -p "$dir"
done
rm -fr segfaults false-positive false-negative

parallel  -j "$jobs" --header : ./1_test.sh {species} {characters} {mutation_rate} {instance} \
          ::: species  80 40 20 10  1280 640 320 160 \
          ::: characters 4 3 2 \
          ::: mutation_rate 0.64 0.32 0.16 0.08 0.04 0.02 0.01  \
          ::: instance {0..19}

# Summary of results
zgrep signal output/*.log.gz | perl -e 's/\.log.gz.*/.out.gz/' -p > segfaults-logs.txt
zgrep Ok output/no*.result | perl -e 's/\.out.gz.*/.out.gz/' -p > false-positive-logs.txt
zgrep No output/ok*.result | perl -e 's/\.out.gz.*/.out.gz/' -p > false-negative-logs.txt
perl -e 's/output/input/' -p segfaults-logs.txt | perl -e 's/\.out.gz/_M.txt/' -p > segfaults.txt
perl -e 's/output/input/' -p false-positive-logs.txt | perl -e 's/\.out.gz/_M.txt/' -p > false-positive.txt
perl -e 's/output/input/' -p false-negative-logs.txt | perl -e 's/\.out.gz/_M.txt/' -p > false-negative.txt

tar czf segfaults.tar.gz -T segfaults.txt
tar czf false-negative.tar.gz -T false-negative.txt
tar czf false-positive.tar.gz -T false-positive.txt
tar czf segfaults-logs.tar.gz -T segfaults-logs.txt
tar czf false-negative-logs.tar.gz -T false-negative-logs.txt
tar czf false-positive-logs.tar.gz -T false-positive-logs.txt

echo "Number of instances: "$(ls -l output/*.log.gz | wc -l)
echo "Segfaults: "$(wc -l segfaults.txt)
echo "False positive: "$(wc -l false-positive.txt)
echo "False negative: "$(wc -l false-negative.txt)
