#!/bin/bash

jobs=$1
[[ "$jobs" = "" ]] && jobs=4

echo "Starting $1 parallel jobs"
for dir in input output ok skeletons-input skeletons-output
do
    test -d "$dir" || mkdir -p "$dir"
done

rm -fr segfaults false-positive false-negative

parallel  -j "$jobs" --header : ./1_test.sh {species} {characters} {mutation_rate} {instance} \
          ::: species 40 20 10 \
          ::: characters 4 3 2 \
          ::: mutation_rate 0.64 0.32 0.16 0.08 0.04 0.02 0.01  \
          ::: instance {0..99}

# TODO reactivate
# parallel  -j "$jobs" --header : ./1_test.sh {species} {characters} {mutation_rate} {instance} \
    #           ::: species 1280 640 320 160 80 \
    #           ::: characters 4 3 2 \
    #           ::: mutation_rate 0.64 0.32 0.16 0.08 0.04 0.02 0.01  \
    #           ::: instance {0..9}

# Summary of results
grep signal output/*.log | perl -e 's/\.log.*/.out.xz/' -p > segfaults-logs.txt
xzgrep Ok output/no*.out.xz | perl -e 's/\.out.xz.*/.out.xz/' -p > false-positive-logs.txt
xzgrep No output/ok*.out.xz | perl -e 's/\.out.xz.*/.out.xz/' -p > false-negative-logs.txt
perl -e 's/output/input/' -p segfaults-logs.txt | perl -e 's/\.out.xz/_M.txt.xz/' -p > segfaults.txt
perl -e 's/output/input/' -p false-positive-logs.txt | perl -e 's/\.out.xz/_M.txt.xz/' -p > false-positive.txt
perl -e 's/output/input/' -p false-negative-logs.txt | perl -e 's/\.out.xz/_M.txt.xz/' -p > false-negative.txt

tar czf segfaults.tar.gz -T segfaults.txt
tar czf false-negative.tar.gz -T false-negative.txt
tar czf false-positive.tar.gz -T false-positive.txt
tar czf segfaults-logs.tar.gz -T segfaults-logs.txt
tar czf false-negative-logs.tar.gz -T false-negative-logs.txt
tar czf false-positive-logs.tar.gz -T false-positive-logs.txt

echo "Number of instances: "$(ls -l output/*.log | wc -l)
echo "Segfaults: "$(wc -l segfaults.txt)
echo "False positive: "$(wc -l false-positive.txt)
echo "False negative: "$(wc -l false-negative.txt)

zgrep signal tests/skeletons-output/*.log.gz | perl -e 's/\.log.gz.*/.out.gz/' -p > skeletons-segfaults-logs.txt
zgrep No tests/skeletons-output/ok*.out.gz | perl -e 's/\.out.gz.*/.out.gz/' -p > skeletons-false-negative-logs.txt
perl -e 's/skeletons-output/skeletons/' -p skeletons-segfaults-logs.txt | perl -e 's/\.out.gz/_M.txt/' -p > skeletons-segfaults.txt
perl -e 's/skeletons-output/skeletons/' -p skeletons-false-negative-logs.txt | perl -e 's/\.out.gz/_M.txt/' -p > skeletons-false-negative.txt

tar cvzf skeletons-segfaults.tar.gz -T skeletons-segfaults.txt
tar cvzf skeletons-false-negative.tar.gz -T skeletons-false-negative.txt
tar cvzf skeletons-segfaults-logs.tar.gz -T skeletons-segfaults-logs.txt
tar cvzf skeletons-false-negative-logs.tar.gz -T skeletons-false-negative-logs.txt
